---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Home - Ambience">
	<div class="space-y-8">
		<div class="text-center">
			<h1 class="text-3xl sm:text-4xl font-bold text-gray-100 mb-2">Ambience</h1>
			<p class="text-gray-400 text-sm sm:text-base">Mix and play ambient sounds</p>
		</div>

		<div class="bg-gray-800 rounded-lg p-4 sm:p-6 border border-gray-700">
			<h2 class="text-xl sm:text-2xl font-semibold text-gray-100 mb-4">Master Controls</h2>
			<div class="space-y-4">
				<div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
					<button
						type="button"
						id="master-play-btn"
						class="p-3 bg-accent hover:bg-accent-600 active:bg-accent-700 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-gray-800 flex items-center justify-center"
					>
						<svg id="master-play-icon" class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
							<path d="M8 5v14l11-7z"/>
						</svg>
						<svg id="master-pause-icon" class="w-6 h-6 text-white hidden" fill="currentColor" viewBox="0 0 24 24">
							<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
						</svg>
					</button>
					<label class="flex items-center gap-2 sm:gap-4 flex-1">
						<svg id="master-volume-speaker-icon" class="w-5 h-5 text-gray-300 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
							<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
						</svg>
						<svg id="master-volume-muted-icon" class="w-5 h-5 text-gray-300 flex-shrink-0 hidden" fill="currentColor" viewBox="0 0 24 24">
							<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
						</svg>
						<input
							type="range"
							min="0"
							max="1"
							step="0.01"
							value="1"
							id="master-volume-slider"
							class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-accent focus:outline-none"
						/>
						<span id="master-volume-value" class="text-gray-300 text-sm sm:text-base w-12 sm:w-16 text-right flex-shrink-0">100%</span>
					</label>
				</div>
			</div>
		</div>

		<div>
			<h2 class="text-xl sm:text-2xl font-semibold text-gray-100 mb-4">Active Sounds</h2>
			<div id="active-sounds-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
				<!-- Active sounds will be rendered here -->
			</div>
			<div id="no-sounds-message" class="text-center py-12 text-gray-400 hidden">
				<p class="text-lg">No sounds active</p>
				<p class="text-sm mt-2">
					Go to the <a href="/sounds" class="text-accent hover:underline">Sounds</a> page to add some!
				</p>
			</div>
		</div>
	</div>
</Layout>

<script is:inline src="/audioManager.js"></script>
<script is:inline>
	const soundsData = {
		sounds: [
			{ id: 'european_forest', name: 'European Forest', thumbnail: '/images/european_forest-thumb.jpg', file: '/sounds/european_forest.mp3' },
			{ id: 'farm_animals', name: 'Farm Animals', thumbnail: '/images/farm_animals-thumb.jpg', file: '/sounds/farm_animals.mp3' },
			{ id: 'forest_birds', name: 'Forest Birds', thumbnail: '/images/forest_birds-thumb.jpg', file: '/sounds/forest_birds.mp3' },
			{ id: 'heavy_rain', name: 'Heavy Rain', thumbnail: '/images/heavy_rain-thumb.jpg', file: '/sounds/heavy_rain.mp3' },
			{ id: 'light_rain', name: 'Light Rain', thumbnail: '/images/light_rain-thumb.jpg', file: '/sounds/light_rain.mp3' },
			{ id: 'night_crickets', name: 'Night Crickets', thumbnail: '/images/night_crickets-thumb.jpg', file: '/sounds/night_crickets.mp3' },
			{ id: 'office_ambience', name: 'Office Ambience', thumbnail: '/images/office_ambience-thumb.jpg', file: '/sounds/office_ambience.mp3' },
			{ id: 'summer_night_crickets', name: 'Summer Night Crickets', thumbnail: '/images/summer_night_crickets-thumb.jpg', file: '/sounds/summer_night _crickets.mp3' },
			{ id: 'windy_campfire', name: 'Windy Campfire', thumbnail: '/images/windy_campfire-thumb.jpg', file: '/sounds/windy_campfire.mp3' },
		],
	};

	const audioManager = new AudioManager();
	const allSounds = soundsData.sounds;

	// Master controls
	const masterPlayBtn = document.getElementById('master-play-btn');
	const masterVolumeSlider = document.getElementById('master-volume-slider');
	const masterVolumeValue = document.getElementById('master-volume-value');
	const activeSoundsContainer = document.getElementById('active-sounds-container');
	const noSoundsMessage = document.getElementById('no-sounds-message');

	function updateMasterVolumeDisplay() {
		const volume = audioManager.getMasterVolume();
		masterVolumeValue.textContent = `${Math.round(volume * 100)}%`;
		updateMasterVolumeIcon();
	}

	function updateMasterVolumeIcon() {
		const speakerIcon = document.getElementById('master-volume-speaker-icon');
		const mutedIcon = document.getElementById('master-volume-muted-icon');
		const volume = audioManager.getMasterVolume();
		
		if (speakerIcon && mutedIcon) {
			if (volume === 0) {
				speakerIcon.classList.add('hidden');
				mutedIcon.classList.remove('hidden');
			} else {
				speakerIcon.classList.remove('hidden');
				mutedIcon.classList.add('hidden');
			}
		}
	}

	function updateMasterPlayButton() {
		const playIcon = document.getElementById('master-play-icon');
		const pauseIcon = document.getElementById('master-pause-icon');
		if (audioManager.isMasterPlaying()) {
			playIcon.classList.add('hidden');
			pauseIcon.classList.remove('hidden');
		} else {
			playIcon.classList.remove('hidden');
			pauseIcon.classList.add('hidden');
		}
	}

	masterPlayBtn.addEventListener('click', () => {
		audioManager.toggleMasterPlay();
		updateMasterPlayButton();
	});

	masterVolumeSlider.addEventListener('input', (e) => {
		const volume = parseFloat(e.target.value);
		audioManager.setMasterVolume(volume);
		updateMasterVolumeDisplay();
	});

	// Render active sounds
	function renderActiveSounds() {
		const activeSounds = audioManager.getActiveSounds();

		if (activeSounds.length === 0) {
			activeSoundsContainer.innerHTML = '';
			noSoundsMessage.classList.remove('hidden');
			return;
		}

		noSoundsMessage.classList.add('hidden');
		activeSoundsContainer.innerHTML = '';

		activeSounds.forEach((sound) => {
			const soundCard = document.createElement('div');
			soundCard.innerHTML = `
				<div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-accent transition-colors" data-sound-id="${sound.id}">
					<div class="flex items-center gap-4">
						<img src="${sound.thumbnail}" alt="${sound.name}" class="w-16 h-16 rounded object-cover flex-shrink-0" />
						<div class="flex-1 min-w-0">
							<h3 class="text-lg font-semibold text-gray-100 truncate">${sound.name}</h3>
							<div class="mt-2 space-y-2">
								<div class="flex items-center gap-2">
									<button type="button" class="sound-mute-btn px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded transition-colors flex-shrink-0" data-sound-id="${sound.id}">
										<span class="mute-text">Mute</span>
									</button>
									<label class="flex items-center gap-1 sm:gap-2 flex-1 min-w-0">
										<svg class="volume-speaker-icon w-4 h-4 text-gray-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" data-sound-id="${sound.id}">
											<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
										</svg>
										<svg class="volume-muted-icon w-4 h-4 text-gray-400 flex-shrink-0 hidden" fill="currentColor" viewBox="0 0 24 24" data-sound-id="${sound.id}">
											<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
										</svg>
										<input type="range" min="0" max="1" step="0.01" value="${audioManager.getSoundVolume(sound.id)}" class="sound-volume-slider flex-1 min-w-0 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-accent" data-sound-id="${sound.id}" />
										<span class="sound-volume-value text-xs text-gray-400 w-8 text-right flex-shrink-0" data-sound-id="${sound.id}">${Math.round(audioManager.getSoundVolume(sound.id) * 100)}%</span>
									</label>
								</div>
								<button type="button" class="sound-remove-btn w-full px-3 py-2 text-sm bg-red-600 hover:bg-red-700 rounded transition-colors" data-sound-id="${sound.id}">
									Remove
								</button>
							</div>
						</div>
					</div>
				</div>
			`;
			activeSoundsContainer.appendChild(soundCard);
		});

		// Attach event listeners
		document.querySelectorAll('.sound-mute-btn').forEach((btn) => {
			btn.addEventListener('click', (e) => {
				const soundId = e.currentTarget.dataset.soundId;
				audioManager.toggleMute(soundId);
				updateMuteButton(soundId);
			});
		});

		document.querySelectorAll('.sound-volume-slider').forEach((slider) => {
			slider.addEventListener('input', (e) => {
				const soundId = e.currentTarget.dataset.soundId;
				const volume = parseFloat(e.target.value);
				audioManager.setSoundVolume(soundId, volume);
				updateVolumeDisplay(soundId);
				updateVolumeIcon(soundId);
			});
		});

		document.querySelectorAll('.sound-remove-btn').forEach((btn) => {
			btn.addEventListener('click', (e) => {
				const soundId = e.currentTarget.dataset.soundId;
				audioManager.removeSound(soundId);
				renderActiveSounds();
				updateMasterPlayButton();
			});
		});
	}

	function updateMuteButton(soundId) {
		const btn = document.querySelector(`.sound-mute-btn[data-sound-id="${soundId}"]`);
		if (btn) {
			const muteText = btn.querySelector('.mute-text');
			if (audioManager.isMuted(soundId)) {
				muteText.textContent = 'Unmute';
				btn.classList.add('bg-red-600', 'hover:bg-red-700');
				btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
			} else {
				muteText.textContent = 'Mute';
				btn.classList.remove('bg-red-600', 'hover:bg-red-700');
				btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
			}
		}
		updateVolumeIcon(soundId);
	}

	function updateVolumeIcon(soundId) {
		const speakerIcon = document.querySelector(`.volume-speaker-icon[data-sound-id="${soundId}"]`);
		const mutedIcon = document.querySelector(`.volume-muted-icon[data-sound-id="${soundId}"]`);
		if (speakerIcon && mutedIcon) {
			const isMuted = audioManager.isMuted(soundId);
			const volume = audioManager.getSoundVolume(soundId);
			const shouldShowMuted = isMuted || volume === 0;
			
			if (shouldShowMuted) {
				speakerIcon.classList.add('hidden');
				mutedIcon.classList.remove('hidden');
			} else {
				speakerIcon.classList.remove('hidden');
				mutedIcon.classList.add('hidden');
			}
		}
	}

	function updateVolumeDisplay(soundId) {
		const volumeValue = document.querySelector(`.sound-volume-value[data-sound-id="${soundId}"]`);
		if (volumeValue) {
			const volume = audioManager.getSoundVolume(soundId);
			volumeValue.textContent = `${Math.round(volume * 100)}%`;
		}
	}

	// Initialize - set slider to loaded volume
	masterVolumeSlider.value = audioManager.getMasterVolume();
	
	updateMasterVolumeDisplay();
	updateMasterPlayButton();
	renderActiveSounds();
	
	// Update volume icons for all active sounds
	audioManager.getActiveSounds().forEach((sound) => {
		updateVolumeIcon(sound.id);
	});

	// Cleanup on page unload
	window.addEventListener('beforeunload', () => {
		audioManager.cleanup();
	});
</script>
