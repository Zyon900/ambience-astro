---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Sounds - Ambience">
	<div class="space-y-6 sm:space-y-8">
		<div class="text-center">
			<h1 class="text-3xl sm:text-4xl font-bold text-gray-100 mb-2">All Sounds</h1>
			<p class="text-gray-400 text-sm sm:text-base">Browse and add sounds to your mix</p>
		</div>

		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sounds-grid">
			<!-- Sounds will be rendered here -->
		</div>
	</div>
</Layout>

<script is:inline src="/audioManager.js"></script>
<script is:inline>
	const soundsData = {
		sounds: [
			{ id: 'rain', name: 'Rain', thumbnail: '/images/rain-thumb.jpg', file: '/sounds/rain.mp3' },
			{
				id: 'ocean',
				name: 'Ocean Waves',
				thumbnail: '/images/ocean-thumb.jpg',
				file: '/sounds/ocean.mp3',
			},
			{ id: 'forest', name: 'Forest', thumbnail: '/images/forest-thumb.jpg', file: '/sounds/forest.mp3' },
			{
				id: 'fireplace',
				name: 'Fireplace',
				thumbnail: '/images/fireplace-thumb.jpg',
				file: '/sounds/fireplace.mp3',
			},
			{ id: 'cafe', name: 'Cafe', thumbnail: '/images/cafe-thumb.jpg', file: '/sounds/cafe.mp3' },
		],
	};

	const audioManager = new AudioManager();
	const allSounds = soundsData.sounds;
	const soundsGrid = document.getElementById('sounds-grid');

	function isSoundActive(soundId) {
		const activeSounds = audioManager.getActiveSounds();
		return activeSounds.some((s) => s.id === soundId);
	}

	function renderSounds() {
		soundsGrid.innerHTML = '';

		allSounds.forEach((sound) => {
			const isActive = isSoundActive(sound.id);
			const soundCard = document.createElement('div');
			soundCard.innerHTML = `
				<div class="bg-gray-800 rounded-lg p-4 border ${
					isActive ? 'border-accent' : 'border-gray-700'
				} hover:border-accent transition-colors" data-sound-id="${sound.id}">
					<div class="flex items-center gap-4">
						<img src="${sound.thumbnail}" alt="${sound.name}" class="w-16 h-16 rounded object-cover flex-shrink-0" />
						<div class="flex-1 min-w-0">
							<h3 class="text-lg font-semibold text-gray-100 truncate">${sound.name}</h3>
							<div class="mt-2 space-y-2">
								<div class="flex items-center gap-2">
									<button type="button" class="sound-play-btn p-2 bg-accent hover:bg-accent-600 rounded transition-colors flex-shrink-0 flex items-center justify-center" data-sound-id="${sound.id}">
										<svg class="play-icon w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
											<path d="M8 5v14l11-7z"/>
										</svg>
										<svg class="pause-icon w-4 h-4 text-white hidden" fill="currentColor" viewBox="0 0 24 24">
											<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
										</svg>
									</button>
									<label class="flex items-center gap-1 sm:gap-2 flex-1 min-w-0">
										<svg class="volume-speaker-icon w-4 h-4 text-gray-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" data-sound-id="${sound.id}">
											<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
										</svg>
										<svg class="volume-muted-icon w-4 h-4 text-gray-400 flex-shrink-0 hidden" fill="currentColor" viewBox="0 0 24 24" data-sound-id="${sound.id}">
											<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
										</svg>
										<input type="range" min="0" max="1" step="0.01" value="${audioManager.getSoundVolume(sound.id)}" class="sound-volume-slider flex-1 min-w-0 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-accent" data-sound-id="${sound.id}" />
										<span class="sound-volume-value text-xs text-gray-400 w-8 text-right flex-shrink-0" data-sound-id="${sound.id}">${Math.round(audioManager.getSoundVolume(sound.id) * 100)}%</span>
									</label>
								</div>
								<button type="button" class="sound-add-btn w-full px-3 py-2 text-sm bg-accent hover:bg-accent-600 rounded transition-colors ${isActive ? 'opacity-50 cursor-not-allowed' : ''}" data-sound-id="${sound.id}">
									${isActive ? 'Already Added' : 'Add to Mix'}
								</button>
							</div>
						</div>
					</div>
				</div>
			`;
			soundsGrid.appendChild(soundCard);
		});

		// Attach event listeners
		document.querySelectorAll('.sound-play-btn').forEach((btn) => {
			btn.addEventListener('click', (e) => {
				const soundId = e.currentTarget.dataset.soundId;
				audioManager.toggleSound(soundId);
				updatePlayButton(soundId);
			});
		});

		document.querySelectorAll('.sound-volume-slider').forEach((slider) => {
			slider.addEventListener('input', (e) => {
				const soundId = e.currentTarget.dataset.soundId;
				const volume = parseFloat(e.target.value);
				audioManager.setSoundVolume(soundId, volume);
				updateVolumeDisplay(soundId);
				updateVolumeIcon(soundId);
			});
		});

		document.querySelectorAll('.sound-add-btn').forEach((btn) => {
			btn.addEventListener('click', (e) => {
				const soundId = e.currentTarget.dataset.soundId;
				const isActive = isSoundActive(soundId);
				
				if (isActive) {
					// Remove sound from mix
					audioManager.removeSound(soundId);
				} else {
					// Add sound to mix
					const sound = allSounds.find((s) => s.id === soundId);
					if (sound) {
						audioManager.addSound(sound);
					}
				}
				
				// Update just this button and card border without re-rendering
				updateSoundCardState(soundId);
			});
		});
	}

	function updatePlayButton(soundId) {
		const btn = document.querySelector(`.sound-play-btn[data-sound-id="${soundId}"]`);
		if (btn) {
			const playIcon = btn.querySelector('.play-icon');
			const pauseIcon = btn.querySelector('.pause-icon');
			if (audioManager.isSoundPlaying(soundId)) {
				playIcon.classList.add('hidden');
				pauseIcon.classList.remove('hidden');
			} else {
				playIcon.classList.remove('hidden');
				pauseIcon.classList.add('hidden');
			}
		}
	}

	function updateVolumeDisplay(soundId) {
		const volumeValue = document.querySelector(`.sound-volume-value[data-sound-id="${soundId}"]`);
		if (volumeValue) {
			const volume = audioManager.getSoundVolume(soundId);
			volumeValue.textContent = `${Math.round(volume * 100)}%`;
		}
	}

	function updateVolumeIcon(soundId) {
		const speakerIcon = document.querySelector(`.volume-speaker-icon[data-sound-id="${soundId}"]`);
		const mutedIcon = document.querySelector(`.volume-muted-icon[data-sound-id="${soundId}"]`);
		if (speakerIcon && mutedIcon) {
			const isMuted = audioManager.isMuted(soundId);
			const volume = audioManager.getSoundVolume(soundId);
			const shouldShowMuted = isMuted || volume === 0;
			
			if (shouldShowMuted) {
				speakerIcon.classList.add('hidden');
				mutedIcon.classList.remove('hidden');
			} else {
				speakerIcon.classList.remove('hidden');
				mutedIcon.classList.add('hidden');
			}
		}
	}

	function updateSoundCardState(soundId) {
		const card = document.querySelector(`[data-sound-id="${soundId}"]`);
		const btn = document.querySelector(`.sound-add-btn[data-sound-id="${soundId}"]`);
		const isActive = isSoundActive(soundId);
		
		// Update card border
		if (isActive) {
			card?.classList.add('border-accent');
			card?.classList.remove('border-gray-700');
		} else {
			card?.classList.remove('border-accent');
			card?.classList.add('border-gray-700');
		}
		
		// Update button state
		if (isActive) {
			btn.textContent = 'Already Added';
			btn?.classList.add('opacity-50', 'cursor-not-allowed');
		} else {
			btn.textContent = 'Add to Mix';
			btn?.classList.remove('opacity-50', 'cursor-not-allowed');
		}
	}

	// Initialize
	renderSounds();
	
	// Update volume icons for all sounds
	allSounds.forEach((sound) => {
		updateVolumeIcon(sound.id);
	});

	// Cleanup on page unload
	window.addEventListener('beforeunload', () => {
		audioManager.cleanup();
	});
</script>
